<!DOCTYPE html>
<html lang="en">
<head>
<title>iNZight rmarkdown</title>
<script src="underscore-min.js"></script>    
<script src="jquery-1.10.2.min.js"></script>
<script src="opencpu-0.4.js"></script>
<script src="src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
$(function(){

  var hash = location.hash.substr(1);
  var rmd = decodeURI(hash).split(",").join("\n");
  if(rmd == "")
  {
	rmd = "Where R you R Markdown?";
  }
  $("#editor").html(rmd);
  
  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/monokai");
  editor.getSession().setMode("ace/mode/r");
  editor.getSession().setUseWrapMode(true);
  editor.setFontSize("14px");
  editor.setShowPrintMargin(false);
  
  function domarkdown(e){
    var textMod = editor.getSession().getValue();
    var hack = textMod.split("\n");
    var newText = [];
    //set defaults for knitr
    newText.push("```{r include = FALSE}");
    newText.push("knitr::opts_chunk$set(tidy = TRUE)");
    newText.push("```");
    
    var chunkHead = "";
    var skip = -1;
    for(var i=0; i<hack.length; i++)
    {
      if(hack[i].substring(0,5) == "```{r")
      {
        chunkHead = hack[i]; 
      }
      
      if(hack[i].substring(0, 12) == "iNZightPlot(")
      {
         //get any fig.width or fig.height details
         //that's all for now for this workaround!
         //will need to address the other options for code chunk
         //with respect to iNZightPlots..... future
         var figWidth = 800; //8
         var figHeight = 500; //5
         var chunkOptions = chunkHead.split("```{r ");
         if(chunkOptions.length > 1)
         {
            var params = chunkOptions[1].split(" ").join("").split(","); 
            for(var p=0; p<params.length; p++)
            {
              if(params[p].substring(0,9) == "fig.width")
              {
                var dimension = params[p].split("=");
                var justNumber = dimension[1].split("}");
                figWidth = Number(justNumber[0])*100;
              }
              if(params[p].substring(0,10) == "fig.height")
              {
                var dimension = params[p].split("=");
                var justNumber = dimension[1].split("}");
                figHeight = Number(justNumber[0])*100;
              }
            }
         }
         
         var ts = Date.now() + Math.random();
         newText.push("```");
         newText.push("```{r echo=2, results='hide'}");
         newText.push("png('" + ts + ".png', width=" + figWidth + ",height=" + figHeight + ")");
         newText.push(hack[i]);
         newText.push("dev.off()");
         newText.push("```");
         newText.push("![](" + ts + ".png)");
         if(hack[i + 1].substring(0,3) !== "```")
          {
            newText.push(chunkHead);
          }
          else
          {
            skip = i + 1;
          }
      }
      else
      {
        if(i !== skip)
        {
          newText.push(hack[i]); 
        }
      }
    }
    textMod = newText.join("\n");
    
    var req = ocpu.call("rmdtext", {
      text : textMod
    }, function(session){
      $("iframe").attr('src', session.getFileURL("output.html")); 
	  $("iframe").on("load", function() {
			$("#render").show();
		});
    }).fail(function(text){
      alert("Error: " + req.responseText);
    });
    
  }
  
 //update when Run code button clicked
$("#runCode").click(function() {
 if($("#runCode").val() == "Edit R Markdown")
	  {
		$("#runCode").val("Knit R Markdown");
		$("#editor").show();
		$("#render").hide();
		$("#dummy").hide();
		$("#loader").hide();
	  }
	  else
	  {
		domarkdown();
		$("#runCode").val("Edit R Markdown");
		$("#editor").hide();
		$("#dummy").show();
		$("#loader").show();
		editor.resize();
	  }
});  
 
  //init on start
  domarkdown();  
});
</script>

<style type="text/css" media="screen">
 
#editor { 
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  z-index: 0;
}

#dummy {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  z-index: 1;
  background-color:#ffffff;
}

#render {
 position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  z-index: 6;
  border: 0;
  margin: 2;
}

#runCode:hover {
  opacity: 0.5;
  cursor: pointer;
}

#runCode {
  position: absolute;
  width: 150px;
  height: 30px;
  z-index: 15;
  right: 5%;
  background: #666666;
  padding: 5px;
  color: #ffffff;
  text-align: center;
}

.loader {
    border: 16px solid #f3f3f3; /* Light grey */
    border-top: 16px solid #A6C0C5; /* Blue */
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
	position: absolute;
	top: 50%;
	left: 50%;
	margin: -120px 0 0 -120px;
	z-index:4;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<input type="button" value="Edit R Markdown" id="runCode">
<div id="editor"></div>
<div id="dummy"></div>
<iframe id="render" src="about:blank"></iframe>
<div class="loader" id="loader"></div>
</body>
</html>
